name: gpt5

on:
  schedule:
    - cron: '15 10 * * 0-4'  # 4:15 PM Nepal Time (10:15 UTC), Sun-Thu
  workflow_dispatch:

jobs:
  run-strategy:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Kathmandu

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy requests

      - name: Run gpt5.py
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "โ          NEPSE TRADING STRATEGY RUNNER                โ"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo ""
          echo "๐ Execution Time: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "๐ค Triggered by: ${{ github.event_name }}"
          echo "๐ Run ID: ${{ github.run_id }}"
          echo ""
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo ""
          
          python gpt5.py
          
          echo ""
          echo "โ Strategy execution complete"

      - name: List generated files
        if: always()
        run: |
          echo ""
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "โ              GENERATED FILES                          โ"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo ""
          
          for file in *.csv *.json *.txt; do
            if [ -f "$file" ]; then
              size=$(ls -lh "$file" | awk '{print $5}')
              lines=$(wc -l < "$file" 2>/dev/null || echo "N/A")
              echo "๐ $file ($size, $lines lines)"
            fi
          done
          
          echo ""

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: strategy-results-${{ github.run_id }}
          path: |
            *.csv
            *.json
            *.txt
          retention-days: 30
          if-no-files-found: warn

      - name: Commit results
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          echo ""
          echo "๐ค Committing results to repository..."
          
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          git add *.csv *.json *.txt 2>/dev/null || true
          
          if git diff-index --quiet HEAD --; then
            echo "โน๏ธ  No changes to commit"
          else
            git commit -m "๐ค Auto-update: Strategy Results - $(date +'%Y-%m-%d %H:%M')"
            git remote set-url origin https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/${{ github.repository }}
            git push origin ${{ github.ref_name }}
            echo "โ Results committed and pushed"
          fi

      - name: Cleanup
        if: always()
        run: |
          echo ""
          echo "๐งน Cleaning up old files..."
          
          # Keep only latest 5 CSV files
          ls -t *.csv 2>/dev/null | tail -n +6 | xargs -r rm -f
          ls -t *.json 2>/dev/null | tail -n +6 | xargs -r rm -f
          
          echo "โ Cleanup complete"

      - name: Workflow summary
        if: always()
        run: |
          echo ""
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo "โ              WORKFLOW COMPLETE                        โ"
          echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          echo ""
          echo "๐ View run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "๐ฅ Download artifacts from the Actions tab"
          echo ""
          echo "โ All tasks completed!"
          echo ""